<script>
  import "@shoelace-style/shoelace/dist/components/button/button.js";
  import { onMount } from "svelte";
  import { goto } from "$app/navigation";
  import { State, Draft, Name, Validate } from "$lib/engines/draft.js";
  import { allyEvent } from "$lib/helpers/event";

  let publishButton, nameParts;
  const Render = State.make();

  Render.cycle = ( draft ) => {
    const match = draft.identities.find( i => i.active === true );
    if ( match == null ) {
      return;
    }
    nameParts = Name.split( match.prettyName );
  };

  Render.cleanup = () => {
    nameParts = [];
  }


  const publish = async function () {
    if ( publishButton.loading === true ) {
      return;
    }

    if ( !Validate.isValid() ) {
      return;
    }
    
    publishButton.loading = true;
    const draft = Draft.read();
    await Draft.publish( draft );
    Draft.clear();
    publishButton.loading = false;
    goto("/home");
  };


  const handleDiscard = allyEvent( Draft.clear );
  const handlePublish = allyEvent( publish );

  Render.reset();
  onMount(() => {
    Render.listen( "identities", Render.cycle );
    return () => {
      Render.reset();
    }
  });
</script>


<h2>Reply</h2>
<p>
  You are replying as

  <span>
    {#each nameParts as part}
      <span>{ part }</span>
    {/each}
  </span>
</p>

<div class="buttons">
  <sl-button
    on:click={handleDiscard}
    on:keypress={handleDiscard}
    class="cancel"
    size="medium"
    pill>
    Discard Draft
  </sl-button>

  <sl-button
    bind:this={publishButton}
    on:click={handlePublish}
    on:keypress={handlePublish}
    class="submit"
    size="medium"
    pill>
    Reply
  </sl-button>
</div>

<style>
  p {
    margin: 0;
  }

  p span {
    display: inline-flex;
    flex-direction: row;
    flex-wrap: wrap;
    justify-content: start;
  }

  p span span {
    flex: 0 0 auto;
    margin: 0;
    word-break: break-all;
  }

  .buttons {
    display: flex;
    flex-direction: row;
    flex-wrap: nowrap;
    justify-content: space-between;
    align-items: center;
    margin-top: 2rem;
    border-top: none;
    padding-top: 0;
  }

  .buttons sl-button {
    margin-bottom: 0;
    width: 10rem;
  }
</style>